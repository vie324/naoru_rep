<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAORU整体 戦略レポート | AI酒井くんによる分析・提案ツール</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Brand Color Definition */
        :root {
            --brand-color: #e57172;
            --brand-light: #fff0f0;
            --brand-dark: #c04d4e;
            --meta-color: #0668E1;
            --meta-light: #e0f2fe;
        }

        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #334155; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        
        /* Utility Classes */
        .text-brand { color: var(--brand-color); }
        .bg-brand { background-color: var(--brand-color); }
        .border-brand { border-color: var(--brand-color); }
        .focus-ring-brand:focus { --tw-ring-color: var(--brand-color); }
        
        /* Tab Styles */
        .tab-btn.active { border-bottom: 3px solid var(--brand-color); color: var(--brand-color); font-weight: 700; }
        .tab-btn { border-bottom: 3px solid transparent; color: #64748b; }

        /* Media Switch Buttons */
        .media-switch-btn {
            flex: 1; padding: 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 700; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; opacity: 0.7; filter: grayscale(100%);
        }
        .media-switch-btn:hover { opacity: 1; background: rgba(255,255,255,0.5); }
        .media-switch-btn.active { opacity: 1; filter: grayscale(0%); background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .media-switch-btn.hpb.active { border-color: var(--brand-color); color: var(--brand-color); }
        .media-switch-btn.meta.active { border-color: var(--meta-color); color: var(--meta-color); }

        /* Progress Bar */
        .progress-bar-bg { background-color: #e2e8f0; border-radius: 9999px; height: 8px; width: 100%; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease-out; }
        
        /* Modal */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }

        /* Chat Bubbles */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.6; margin-bottom: 12px; animation: fadeIn 0.3s ease-in-out; }
        .chat-bubble.user { background-color: #475569; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
        .chat-bubble.ai { background-color: #ffffff; color: #334155; margin-right: auto; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Enhanced AI Mode Toggle */
        .ai-mode-container { background-color: #e2e8f0; padding: 4px; border-radius: 8px; display: flex; position: relative; width: 100%; max-width: 300px; }
        .ai-mode-btn { flex: 1; padding: 8px 12px; font-size: 0.8rem; font-weight: 600; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px; border: none; color: #64748b; }
        .ai-mode-btn.active { background-color: white; color: var(--brand-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 700; }
        .ai-mode-btn:hover:not(.active) { background-color: rgba(255,255,255,0.5); color: #475569; }

        /* Data Input Table */
        .input-cell { @apply bg-white border border-slate-300 rounded px-1 py-1.5 text-center w-full text-xs focus:ring-2 focus:ring-brand focus:border-brand outline-none transition-shadow font-medium text-slate-700; }
        .calc-cell { @apply bg-slate-100 border border-slate-200 rounded px-1 py-1.5 text-center w-full text-xs text-slate-500 cursor-not-allowed font-medium; }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Loading Animation */
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: var(--brand-color); border-radius: 50%; animation: typing 1s infinite ease-in-out; margin-right: 4px; }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-5px); opacity: 1; } }

        /* Smart Parser Area */
        .smart-parser-area { background: #ffffff; border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .smart-parser-area:hover, .smart-parser-area:focus-within { border-color: var(--brand-color); background: #fffcfc; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-brand text-white p-2 rounded-lg shadow-sm"><i class="fa-solid fa-chart-line"></i></div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">NAORU整体 戦略レポート</h1>
                    <p class="text-xs text-slate-500">AI酒井くんによる分析・提案ツール</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 h-full">
                <!-- Tab Navigation -->
                <div class="hidden md:flex space-x-2 h-full mr-4">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active h-full flex items-center gap-2 px-3 text-sm font-medium transition-colors">
                        <i class="fa-solid fa-table-columns"></i> ダッシュボード
                    </button>
                    <button onclick="switchTab('deepdive')" id="tab-deepdive" class="tab-btn h-full flex items-center gap-2 px-3 text-sm font-medium transition-colors">
                        <i class="fa-solid fa-store"></i> 詳細・AI分析
                    </button>
                    <button onclick="switchTab('input')" id="tab-input" class="tab-btn h-full flex items-center gap-2 px-3 text-sm font-medium transition-colors">
                        <i class="fa-solid fa-pen-to-square"></i> 実績データ管理
                    </button>
                </div>
                <button onclick="toggleModal('apiKeyModal')" class="text-slate-500 hover-text-brand transition-colors" title="APIキー設定">
                    <i class="fa-solid fa-gear text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- API Key Alert -->
        <div id="apiKeyAlert" class="hidden bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r shadow-sm flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa-solid fa-triangle-exclamation text-amber-500 mr-3 text-xl"></i>
                <div>
                    <p class="font-bold text-amber-800 text-sm">AI機能の準備ができていません</p>
                    <p class="text-xs text-amber-700">「AI酒井くん」を使用するには、右上の設定(⚙️)からGemini APIキーを入力してください。</p>
                </div>
            </div>
            <button onclick="toggleModal('apiKeyModal')" class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-2 rounded hover:bg-amber-200">設定する</button>
        </div>

        <!-- ========================================== -->
        <!-- TAB 1: DASHBOARD                           -->
        <!-- ========================================== -->
        <div id="view-dashboard" class="space-y-8">
            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                <div class="flex items-center gap-2">
                    <i class="fa-regular fa-calendar-days text-slate-400"></i>
                    <span class="text-sm font-bold text-slate-700">表示データ基準:</span>
                </div>
                <select id="targetDateSelect" onchange="changeTargetDate()" class="bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg p-2.5 focus:ring-brand focus:border-brand outline-none font-bold">
                    <!-- Populated by JS -->
                </select>
            </div>

            <!-- Summary Cards -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Ito Summary -->
                <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-brand relative overflow-hidden">
                    <div class="absolute right-4 top-4 opacity-10 text-6xl text-brand"><i class="fa-solid fa-user-tie"></i></div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">伊藤オーナー <span class="text-sm font-normal text-slate-500">(関内・溝の口・上大岡)</span></h2>
                    <div class="grid grid-cols-2 gap-4 mt-4 relative z-10">
                        <div class="bg-brand-light p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">平均CPA (HPB)</p>
                            <p class="text-2xl font-bold text-brand" id="itoCpaDisplay">-</p>
                            <span class="text-xs font-bold text-white bg-emerald-500 px-2 py-0.5 rounded-full">目標達成</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">全体入会率 (HPB)</p>
                            <p class="text-2xl font-bold text-slate-700" id="itoRateDisplay">-</p>
                            <span class="text-xs font-bold text-white bg-rose-500 px-2 py-0.5 rounded-full">未達 (目標50%)</span>
                        </div>
                    </div>
                </div>
                <!-- Fukumoto Summary -->
                <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-slate-600 relative overflow-hidden">
                    <div class="absolute right-4 top-4 opacity-10 text-6xl text-slate-600"><i class="fa-solid fa-user-tie"></i></div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">福本オーナー <span class="text-sm font-normal text-slate-500">(鶴見・藤沢)</span></h2>
                    <div class="grid grid-cols-2 gap-4 mt-4 relative z-10">
                        <div class="bg-slate-100 p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">平均CPA (HPB)</p>
                            <p class="text-2xl font-bold text-slate-700" id="fukuCpaDisplay">-</p>
                            <span class="text-xs font-bold text-white bg-rose-500 px-2 py-0.5 rounded-full">未達</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">全体入会率 (HPB)</p>
                            <p class="text-2xl font-bold text-slate-700" id="fukuRateDisplay">-</p>
                            <span class="text-xs font-bold text-white bg-rose-500 px-2 py-0.5 rounded-full">未達</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ranking Charts -->
            <section class="bg-white rounded-xl shadow-sm p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-sm font-bold text-slate-600 mb-2 text-center">CPA (獲得単価) <span class="text-xs font-normal text-slate-400">低いほど優秀</span></h4>
                        <div class="chart-container"><canvas id="cpaChart"></canvas></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-600 mb-2 text-center">入会率 (リピート率) <span class="text-xs font-normal text-slate-400">高いほど優秀</span></h4>
                        <div class="chart-container"><canvas id="rateChart"></canvas></div>
                    </div>
                </div>
                <div class="mt-8 overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-slate-600 border border-slate-200">
                        <thead class="bg-slate-50 text-slate-700 font-bold">
                            <tr>
                                <th class="px-4 py-3 border-b text-center">順位</th>
                                <th class="px-4 py-3 border-b">店舗名</th>
                                <th class="px-4 py-3 border-b">オーナー</th>
                                <th class="px-4 py-3 border-b text-right">CPA実績</th>
                                <th class="px-4 py-3 border-b text-right">入会率</th>
                                <th class="px-4 py-3 border-b text-center">判定</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="comparisonTableBody"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- ========================================== -->
        <!-- TAB 2: DEEP DIVE (Chat)                    -->
        <!-- ========================================== -->
        <div id="view-deepdive" class="space-y-8 hidden">
             <!-- Control Panel -->
            <section class="bg-white rounded-xl shadow-sm p-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="bg-slate-800 text-white p-3 rounded-lg"><i class="fa-solid fa-store"></i></div>
                    <div>
                        <h2 class="text-lg font-bold">全店舗・競合・PV分析</h2>
                        <p class="text-xs text-slate-500">店舗を選択すると、AI酒井くんの脳内が切り替わります</p>
                    </div>
                </div>
                <div class="w-full md:w-1/3">
                    <label class="block text-xs font-bold text-slate-500 mb-1">分析対象店舗を選択</label>
                    <select id="deepDiveSelect" onchange="changeStore()" class="w-full bg-slate-50 border border-slate-300 text-slate-800 rounded-lg p-2.5 focus:ring-brand focus:border-brand outline-none">
                    </select>
                </div>
            </section>

            <!-- Main Detail Content -->
            <div id="storeDetailContainer" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Left: Static Data -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-brand" id="detailCardBorder">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold text-slate-800" id="detailName">店舗名</h3>
                                <p class="text-sm text-slate-500" id="detailOwner">オーナー名</p>
                            </div>
                            <div class="text-right">
                                <a id="detailLink" href="#" target="_blank" class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-slate-200 transition flex items-center gap-1 mb-2">HPB <i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                                <p class="text-xs font-bold text-brand" id="detailOfferPrice">初回: -</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="p-3 bg-slate-50 rounded text-center">
                                <p class="text-xs text-slate-500">新規(HPB)</p>
                                <p class="text-xl font-bold text-slate-800" id="detailNew">-</p>
                            </div>
                            <div class="p-3 bg-slate-50 rounded text-center">
                                <p class="text-xs text-slate-500">CPA実績</p>
                                <p class="text-xl font-bold" id="detailCPA">-</p>
                            </div>
                        </div>
                        <!-- PV Stats Mini View -->
                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <p class="text-xs font-bold text-slate-500 mb-2">Webアクセス状況 (自店 vs エリア平均)</p>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="block text-slate-400">TOP PV</span>
                                    <span class="font-bold text-slate-700" id="detailTopPv">-</span>
                                    <span class="text-[10px] text-slate-400 block" id="detailAreaTopPv">(Avg: -)</span>
                                </div>
                                <div>
                                    <span class="block text-slate-400">クーポンPV</span>
                                    <span class="font-bold text-slate-700" id="detailCouponPv">-</span>
                                    <span class="text-[10px] text-slate-400 block" id="detailAreaCouponPv">(Avg: -)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Staff -->
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-user-nurse text-brand"></i> スタッフ別 成約率</h4>
                        <div id="staffList" class="space-y-4"></div>
                    </div>
                    <!-- Competitor (With AI Update Button) -->
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm relative overflow-hidden">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-crosshairs text-slate-500"></i> エリア競合比較 (5-10店舗)</h4>
                            <button onclick="updateCompetitorInfo()" id="compUpdateBtn" class="text-xs bg-brand hover:bg-rose-400 text-white font-bold px-3 py-1 rounded transition flex items-center gap-1 shadow-sm">
                                <i class="fa-solid fa-arrows-rotate"></i> AI調査開始
                            </button>
                        </div>
                        <div id="competitorList" class="space-y-2 max-h-[300px] overflow-y-auto pr-1"></div>
                    </div>
                </div>

                <!-- Right: AI Chat -->
                <div class="lg:col-span-7 h-[850px] flex flex-col">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-t-xl shadow-lg p-4 text-white flex-shrink-0">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="relative flex-shrink-0">
                                    <div class="bg-gradient-to-r from-brand to-rose-400 w-10 h-10 rounded-full flex items-center justify-center text-white border-2 border-white shadow"><i class="fa-solid fa-user-tie text-lg"></i></div>
                                    <span class="absolute -bottom-1 -right-1 bg-green-500 w-3 h-3 rounded-full border-2 border-slate-800"></span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-base">AI酒井くん <span class="text-xs font-normal text-slate-400 ml-2">Online</span></h3>
                                    <p class="text-[10px] text-slate-400">キャッチーな広告表現を生成します</p>
                                </div>
                            </div>
                            <div class="ai-mode-container">
                                <button onclick="setAiMode('analyze')" id="mode-analyze" class="ai-mode-btn active"><i class="fa-solid fa-chart-pie"></i> 現状分析</button>
                                <button onclick="setAiMode('copywrite')" id="mode-copywrite" class="ai-mode-btn inactive"><i class="fa-solid fa-pen-nib"></i> HPB原稿作成</button>
                            </div>
                        </div>
                        <details class="bg-slate-700/50 rounded border border-slate-600">
                            <summary class="px-3 py-2 text-xs font-bold text-slate-300 cursor-pointer hover:bg-slate-700 flex items-center justify-between"><span><i class="fa-solid fa-lightbulb text-yellow-400 mr-2"></i>AIに前提知識を与える (こだわり・強み)</span><i class="fa-solid fa-chevron-down text-slate-500"></i></summary>
                            <div class="p-2">
                                <textarea id="customKnowledge" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-brand outline-none h-16 placeholder-slate-500" placeholder="例：30代の産後ママをターゲットにしたい。"></textarea>
                            </div>
                        </details>
                    </div>
                    <div id="chatContainer" class="flex-grow bg-slate-100 p-4 overflow-y-auto border-x border-slate-200">
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 text-sm opacity-60" id="chatPlaceholder">
                            <i class="fa-solid fa-comments text-4xl mb-3"></i>
                            <p class="text-center" id="chatPlaceholderText">現状分析モードです。<br>下のボタンを押すと分析を開始します。</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-b-xl border-t border-slate-200 flex-shrink-0">
                        <button onclick="triggerAiAction()" id="auditBtn" class="w-full bg-brand hover:bg-rose-400 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 mb-3 transition-all">
                            <span id="auditBtnText">店舗・競合・スタッフ課題を分析する</span><i class="fa-solid fa-paper-plane"></i>
                        </button>
                        <div class="flex gap-2">
                            <input type="text" id="userChatInput" class="flex-grow bg-slate-100 border border-slate-300 text-slate-800 text-sm rounded-lg focus:ring-brand focus:border-brand p-2.5 outline-none transition-all" placeholder="酒井くんに質問や修正指示を送る..." onkeypress="handleKeyPress(event)">
                            <button onclick="sendUserMessage()" id="sendBtn" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB 3: DATA INPUT (Auto Input)             -->
        <!-- ========================================== -->
        <div id="view-input" class="space-y-8 hidden">
            
            <!-- AI Auto Input Section -->
            <section class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-xl shadow-lg p-6 mb-8 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-robot text-8xl"></i></div>
                <div class="relative z-10">
                    <h3 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles text-yellow-400"></i> AIスマート読取 (レポート一括入力)</h3>
                    <p class="text-xs text-slate-300 mb-4">チャットの報告文やPDF(テキストコピー)を貼り付けると、AIが解析して下表に自動入力します。</p>
                    
                    <!-- HINT SECTION START -->
                    <div class="mb-4 bg-slate-600/50 rounded-lg border border-slate-500 p-3 text-xs">
                        <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="document.getElementById('formatDetails').classList.toggle('hidden')">
                            <span class="font-bold text-yellow-300"><i class="fa-solid fa-circle-info mr-1"></i> 精度を上げるための入力のコツ</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div id="formatDetails" class="hidden text-slate-200 space-y-2">
                            <p>以下のような形式で入力すると、AIが正確に認識しやすくなります。</p>
                            <div class="bg-slate-800 p-2 rounded font-mono text-[10px] leading-relaxed border border-slate-600 select-all">
                                2025年12月 関内店 (HPB実績)<br>
                                広告費：55,000円<br>
                                新規数：12名<br>
                                入会数：7名<br>
                                TOP PV：1,500 / クーポンPV：300
                            </div>
                            <p class="opacity-80">※「店舗名」「年月」が含まれていることが重要です。<br>※項目名は「広告費」「コスト」、「新規」「集客数」など一般的な言葉であれば認識します。</p>
                        </div>
                    </div>
                    <!-- HINT SECTION END -->

                    <div class="smart-parser-area p-3 rounded-lg mb-4 bg-white border-2 border-dashed border-slate-300 hover:border-brand transition-colors">
                        <textarea id="reportPasteArea" class="w-full bg-white text-slate-800 text-sm p-3 outline-none h-32 placeholder-slate-400 resize-none font-medium" placeholder="ここにレポートのテキストを貼り付けてください...&#13;&#10;例：&#13;&#10;2025/12 関内店&#13;&#10;HPB新規: 12名&#13;&#10;広告費: 55000円..."></textarea>
                    </div>
                    
                    <button onclick="analyzeReportText()" id="parseBtn" class="bg-brand hover:bg-rose-500 text-white font-bold py-2 px-6 rounded-lg text-sm transition-all shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-microchip"></i> 解析して入力表に反映
                    </button>
                </div>
            </section>

            <section class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-pen-to-square text-brand"></i> 実績数値入力
                        </h2>
                    </div>
                    <div class="flex items-center gap-4 mt-4 md:mt-0 w-full md:w-auto">
                        <select id="inputStoreSelect" onchange="renderInputTable()" class="bg-slate-50 border border-slate-300 text-slate-800 text-sm rounded-lg p-2.5 focus:ring-brand focus:border-brand outline-none flex-grow md:flex-grow-0">
                            <!-- Populated by JS -->
                        </select>
                        <button onclick="saveMonthlyData()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition-colors shadow flex items-center gap-2">
                            <i class="fa-solid fa-floppy-disk"></i> 保存
                        </button>
                    </div>
                </div>

                <!-- Media Switch -->
                <div class="media-switch-container">
                    <div onclick="switchInputMedia('hpb')" id="media-hpb" class="media-switch-btn hpb active">
                        <i class="fa-solid fa-scissors"></i> ホットペッパー
                    </div>
                    <div onclick="switchInputMedia('meta')" id="media-meta" class="media-switch-btn meta inactive">
                        <i class="fa-brands fa-meta"></i> Meta広告
                    </div>
                </div>

                <!-- 1. Store Metrics -->
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-slate-700 mb-2 pl-2 border-l-4 border-slate-400">店舗実績 (月次)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-[1300px] text-sm text-left text-slate-600 border border-slate-200">
                            <thead class="bg-slate-100 text-slate-700 font-bold sticky top-0" id="inputTableHeader"></thead>
                            <tbody id="inputTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Staff Metrics -->
                <div>
                    <h3 class="text-sm font-bold text-slate-700 mb-2 pl-2 border-l-4 border-slate-400">スタッフ実績 (月次)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-[1000px] text-sm text-left text-slate-600 border border-slate-200">
                            <thead class="bg-slate-100 text-slate-700 font-bold sticky top-0" id="staffTableHeader"></thead>
                            <tbody id="staffTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

            </section>

        </div>

    </main>

    <!-- API Key Modal (Same as before) -->
    <div id="apiKeyModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-slate-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-slate-800">Gemini API設定</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal('apiKeyModal')"><i class="fa-solid fa-xmark text-slate-500 text-xl"></i></div>
                </div>
                <p class="text-sm text-slate-600 mb-4">AI酒井くんを使用するにはGoogle Gemini APIキーが必要です。</p>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:border-brand" id="apiKeyInput" type="password">
                <div class="flex justify-end pt-4 gap-2">
                    <button onclick="toggleModal('apiKeyModal')" class="px-4 py-2 bg-slate-200 text-slate-600 rounded hover:bg-slate-300 transition text-sm">キャンセル</button>
                    <button onclick="saveApiKey()" class="px-4 py-2 bg-brand text-white rounded hover:bg-rose-500 transition text-sm font-bold">保存する</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-slate-800 text-slate-400 py-6 text-center text-xs mt-12">
        <p>NAORU Seitai Management System | Powered by Gemini API</p>
    </footer>

    <!-- Logic Script -->
    <script>
        // --- 0. Utils & Globals ---
        let currentTargetYear = 2025;
        let currentTargetMonth = 12;
        let currentInputMedia = 'hpb'; // 'hpb' or 'meta'

        function toggleModal(modalID){
            document.getElementById(modalID).classList.toggle("opacity-0");
            document.getElementById(modalID).classList.toggle("pointer-events-none");
            document.body.classList.toggle("modal-active");
            if (!document.getElementById(modalID).classList.contains("opacity-0")) {
                const key = localStorage.getItem("naoru_gemini_api_key");
                if (key) document.getElementById("apiKeyInput").value = key;
            }
        }
        function saveApiKey() {
            const key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("naoru_gemini_api_key", key);
                document.getElementById("apiKeyAlert").classList.add("hidden");
                toggleModal('apiKeyModal');
                alert("APIキーを保存しました。");
            } else alert("APIキーを入力してください。");
        }
        function checkApiKey() {
            const key = localStorage.getItem("naoru_gemini_api_key");
            if (!key) {
                document.getElementById("apiKeyAlert").classList.remove("hidden");
                return false;
            }
            return key;
        }

        // --- 1. Data Structure ---
        const masterStores = [
            { id: 0, owner: "伊藤", store: "関内", url: "https://beauty.hotpepper.jp/kr/slnH000551741/", offer: 3500 },
            { id: 1, owner: "伊藤", store: "溝の口", url: "https://beauty.hotpepper.jp/kr/slnH000690916/", offer: 2200 },
            { id: 2, owner: "伊藤", store: "上大岡", url: "https://beauty.hotpepper.jp/kr/slnH000720856/", offer: 3500 },
            { id: 3, owner: "福本", store: "鶴見", url: "https://beauty.hotpepper.jp/kr/slnH000675689/", offer: 3300 },
            { id: 4, owner: "福本", store: "藤沢", url: "https://beauty.hotpepper.jp/kr/slnH000765038/", offer: 3300 }
        ];

        // Monthly Data (LocalStorage)
        let monthlyData = JSON.parse(localStorage.getItem("naoru_monthly_data")) || {};
        
        // Competitor Data (LocalStorage or Default)
        let competitorData = JSON.parse(localStorage.getItem("naoru_competitor_data")) || {
            0: [{name: "カラダファクトリー", price: 3980, feature: "大手"}, {name: "関内カイロ", price: 4500, feature: "老舗"}],
            1: [{name: "溝の口整体院", price: 2980, feature: "地域密着"}, {name: "Re.Ra.Ku", price: 3500, feature: "リラク"}],
            2: [{name: "あおぞら整骨院", price: 2600, feature: "最安"}, {name: "匠", price: 2980, feature: "個室"}],
            3: [{name: "鶴見中央整骨院", price: 1500, feature: "保険"}, {name: "ラフィネ", price: 2200, feature: "リラク"}],
            4: [{name: "藤沢整体院", price: 3980, feature: "優しさ"}, {name: "りらくる", price: 2980, feature: "深夜"}]
        };

        const staticDetails = {
            0: { staff: ["福本", "福倉"] },
            1: { staff: ["米谷", "大野", "永田"] },
            2: { staff: ["有路", "岡本"] },
            3: { staff: ["貞末", "谷口"] },
            4: { staff: ["宮川"] }
        };

        const getKey = (storeId, year, month, media) => `${storeId}_${year}_${month}_${media}`;
        const getStaffKey = (storeId, year, month, media, staffName) => `${storeId}_${year}_${month}_${media}_${staffName}`;

        const getMonthlyRecord = (storeId, year, month, media) => {
            const key = getKey(storeId, year, month, media);
            if (monthlyData[key]) return monthlyData[key];

            // Defaults for 2025/12 HPB (Seed Data)
            if (year === 2025 && month === 12 && media === 'hpb') {
                const defaults = {
                    0: { adSpend: 55000, newClients: 12, joins: 7, topPv: 1500, couponPv: 300, areaTopPv: 1200, areaCouponPv: 250, offerMemo: 3500 },
                    1: { adSpend: 44000, newClients: 20, joins: 7, topPv: 2000, couponPv: 150, areaTopPv: 1200, areaCouponPv: 250, offerMemo: 2200 },
                    2: { adSpend: 55000, newClients: 2, joins: 2, topPv: 300, couponPv: 50, areaTopPv: 1200, areaCouponPv: 250, offerMemo: 3500 },
                    3: { adSpend: 55000, newClients: 8, joins: 3, topPv: 1200, couponPv: 200, areaTopPv: 1200, areaCouponPv: 250, offerMemo: 3300 },
                    4: { adSpend: 55000, newClients: 6, joins: 3, topPv: 1000, couponPv: 180, areaTopPv: 1200, areaCouponPv: 250, offerMemo: 3300 }
                };
                if(defaults[storeId]) return defaults[storeId];
            }
            return { adSpend: 0, newClients: 0, joins: 0, topPv: 0, couponPv: 0, areaTopPv: 0, areaCouponPv: 0, offerMemo: 0, ctr: 0, cpc: 0, cvr: 0, cpm: 0 };
        };

        const getStaffRecord = (storeId, year, month, media, staffName) => {
            const key = getStaffKey(storeId, year, month, media, staffName);
            if (monthlyData[key]) return monthlyData[key];
            return { newClients: 0, joins: 0 };
        };

        let activeStoreData = [];

        function refreshActiveData() {
            activeStoreData = masterStores.map(s => {
                // Dashboard uses HPB data by default for simplicity, but we load staff data for detail view
                const rec = getMonthlyRecord(s.id, currentTargetYear, currentTargetMonth, 'hpb');
                const cpa = rec.newClients > 0 ? Math.round(rec.adSpend / rec.newClients) : 0;
                const rate = rec.newClients > 0 ? Math.round((rec.joins / rec.newClients) * 100) : 0;
                
                // Get Staff Data for this month (HPB)
                const staffStats = staticDetails[s.id].staff.map(name => {
                    const sRec = getStaffRecord(s.id, currentTargetYear, currentTargetMonth, 'hpb', name);
                    // Use seed for demo display if data missing in seed month
                    let arrivals = sRec.newClients;
                    let joins = sRec.joins;
                    if(arrivals === 0 && currentTargetYear === 2025 && currentTargetMonth === 12) {
                        // Demo data fallback logic can go here if needed
                    }
                    return { name, arrivals, joins };
                });

                return {
                    ...s,
                    cpa: cpa,
                    rate: rate,
                    newClients: rec.newClients,
                    topPv: rec.topPv || 0,
                    couponPv: rec.couponPv || 0,
                    areaTopPv: rec.areaTopPv || 0,
                    areaCouponPv: rec.areaCouponPv || 0,
                    offerMemo: rec.offerMemo || 0,
                    staff: staffStats,
                    competitors: competitorData[s.id] || []
                };
            });
        }

        // --- UI Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'dashboard') {
                refreshActiveData();
                initComparisonCharts();
                populateComparisonTable();
                updateDashboardSummaries();
                initTargetDateSelect();
            } else if (tabName === 'deepdive') {
                refreshActiveData();
                initDeepDive();
            } else if (tabName === 'input') {
                initInputTab();
            }
        }

        // --- Data Input Logic (Multi-Channel & Staff) ---
        function switchInputMedia(media) {
            currentInputMedia = media;
            document.getElementById('media-hpb').className = `media-switch-btn hpb ${media === 'hpb' ? 'active' : 'inactive'}`;
            document.getElementById('media-meta').className = `media-switch-btn meta ${media === 'meta' ? 'active' : 'inactive'}`;
            renderInputTable();
        }

        function initInputTab() {
            const select = document.getElementById('inputStoreSelect');
            if(select.options.length === 0) {
                masterStores.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = `${s.store}店 (${s.owner}オーナー)`;
                    select.appendChild(opt);
                });
            }
            renderInputTable();
        }

        function renderInputTable() {
            const storeId = parseInt(document.getElementById('inputStoreSelect').value);
            const tbody = document.getElementById('inputTableBody');
            const thead = document.getElementById('inputTableHeader');
            const staffThead = document.getElementById('staffTableHeader');
            const staffTbody = document.getElementById('staffTableBody');
            
            tbody.innerHTML = '';
            staffTbody.innerHTML = '';

            // 1. Config Headers based on Media
            if (currentInputMedia === 'hpb') {
                thead.innerHTML = `<tr><th class="px-4 py-2 border-b w-24 text-center">年月</th><th class="px-2 py-2 border-b text-center w-24 bg-yellow-50">オファー(円)</th><th class="px-2 py-2 border-b text-center w-28">広告費</th><th class="px-2 py-2 border-b text-center w-20">新規</th><th class="px-2 py-2 border-b text-center w-20">入会</th><th class="px-2 py-2 border-b text-center w-20 bg-blue-50">TOP PV</th><th class="px-2 py-2 border-b text-center w-20 bg-blue-50">Cpn PV</th><th class="px-2 py-2 border-b text-center w-20 bg-slate-50">Area TOP</th><th class="px-2 py-2 border-b text-center w-20 bg-slate-50">Area Cpn</th><th class="px-2 py-2 border-b text-center bg-slate-100">CPA</th><th class="px-2 py-2 border-b text-center bg-slate-100">率</th></tr>`;
            } else {
                thead.innerHTML = `<tr><th class="px-4 py-2 border-b w-24 text-center">年月</th><th class="px-2 py-2 border-b text-center w-24 bg-yellow-50">オファー(円)</th><th class="px-2 py-2 border-b text-center w-28">広告費</th><th class="px-2 py-2 border-b text-center w-20">新規</th><th class="px-2 py-2 border-b text-center w-20">入会</th><th class="px-2 py-2 border-b text-center w-20">CTR (%)</th><th class="px-2 py-2 border-b text-center w-20">CPC (円)</th><th class="px-2 py-2 border-b text-center w-20">CVR (%)</th><th class="px-2 py-2 border-b text-center w-20">CPM (円)</th><th class="px-2 py-2 border-b text-center bg-slate-100">CPA</th><th class="px-2 py-2 border-b text-center bg-slate-100">率</th></tr>`;
            }

            // Staff Header
            let staffList = staticDetails[storeId].staff; 
            let staffHeaderHTML = `<tr><th class="px-4 py-2 border-b w-24 text-center">年月</th>`;
            staffList.forEach(name => { staffHeaderHTML += `<th class="px-2 py-2 border-b text-center bg-slate-50" colspan="2">${name}</th>`; });
            staffHeaderHTML += `</tr><tr><th></th>`; 
            staffList.forEach(name => { staffHeaderHTML += `<th class="px-1 py-1 border-b text-center text-xs text-slate-500">新規</th><th class="px-1 py-1 border-b text-center text-xs text-slate-500">入会</th>`; });
            staffHeaderHTML += `</tr>`;
            staffThead.innerHTML = staffHeaderHTML;

            // 2. Render Rows (2025-2026)
            [2025, 2026].forEach(year => {
                for (let month = 1; month <= 12; month++) {
                    const rec = getMonthlyRecord(storeId, year, month, currentInputMedia);
                    const cpa = rec.newClients > 0 ? Math.round(rec.adSpend / rec.newClients) : 0;
                    const rate = rec.newClients > 0 ? Math.round((rec.joins / rec.newClients) * 100) : 0;
                    const rowClass = (year === currentTargetYear && month === currentTargetMonth) ? "bg-slate-50 font-bold" : "";

                    let rowHTML = `<td class="px-4 py-2 border-b text-center ${rowClass}">${year}/${month}</td>
                        <td class="px-2 py-2 border-b"><input type="number" class="input-cell bg-yellow-50 focus:ring-yellow-400 focus:border-yellow-400" data-year="${year}" data-month="${month}" data-field="offerMemo" value="${rec.offerMemo}" placeholder="¥"></td>
                        <td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="adSpend" value="${rec.adSpend}"></td>
                        <td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="newClients" value="${rec.newClients}"></td>
                        <td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="joins" value="${rec.joins}"></td>`;

                    if (currentInputMedia === 'hpb') {
                        rowHTML += `<td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="topPv" value="${rec.topPv}"></td><td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="couponPv" value="${rec.couponPv}"></td><td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="areaTopPv" value="${rec.areaTopPv}"></td><td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="areaCouponPv" value="${rec.areaCouponPv}"></td>`;
                    } else {
                        rowHTML += `<td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="ctr" value="${rec.ctr}" step="0.01"></td><td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="cpc" value="${rec.cpc}"></td><td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="cvr" value="${rec.cvr}" step="0.01"></td><td class="px-2 py-2 border-b"><input type="number" class="input-cell" data-year="${year}" data-month="${month}" data-field="cpm" value="${rec.cpm}"></td>`;
                    }
                    rowHTML += `<td class="px-2 py-2 border-b"><div class="calc-cell">¥${cpa.toLocaleString()}</div></td><td class="px-2 py-2 border-b"><div class="calc-cell">${rate}%</div></td>`;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = rowHTML;
                    tbody.appendChild(tr);

                    // Staff Row
                    let staffRowHTML = `<td class="px-4 py-2 border-b text-center ${rowClass}">${year}/${month}</td>`;
                    staffList.forEach(name => {
                        const sRec = getStaffRecord(storeId, year, month, currentInputMedia, name);
                        staffRowHTML += `<td class="px-1 py-2 border-b border-l"><input type="number" class="input-cell staff-input" data-year="${year}" data-month="${month}" data-staff="${name}" data-field="newClients" value="${sRec.newClients}"></td><td class="px-1 py-2 border-b"><input type="number" class="input-cell staff-input" data-year="${year}" data-month="${month}" data-staff="${name}" data-field="joins" value="${sRec.joins}"></td>`;
                    });
                    const staffTr = document.createElement('tr');
                    staffTr.innerHTML = staffRowHTML;
                    staffTbody.appendChild(staffTr);
                }
            });
        }

        function saveMonthlyData() {
            const storeId = parseInt(document.getElementById('inputStoreSelect').value);
            const inputs = document.querySelectorAll('#inputTableBody input');
            inputs.forEach(input => {
                const key = getKey(storeId, input.dataset.year, input.dataset.month, currentInputMedia);
                if (!monthlyData[key]) monthlyData[key] = {};
                monthlyData[key][input.dataset.field] = parseFloat(input.value) || 0;
            });
            const staffInputs = document.querySelectorAll('.staff-input');
            staffInputs.forEach(input => {
                const key = getStaffKey(storeId, input.dataset.year, input.dataset.month, currentInputMedia, input.dataset.staff);
                if (!monthlyData[key]) monthlyData[key] = {};
                monthlyData[key][input.dataset.field] = parseInt(input.value) || 0;
            });
            localStorage.setItem("naoru_monthly_data", JSON.stringify(monthlyData));
            refreshActiveData();
            renderInputTable();
            alert('データを保存しました。');
        }

        // --- AI Auto Input (Smart Parser) FIXED ---
        async function analyzeReportText() {
            const apiKey = checkApiKey();
            if (!apiKey) { toggleModal('apiKeyModal'); return; }

            const text = document.getElementById('reportPasteArea').value;
            if (!text) { alert("レポートテキストを入力してください"); return; }

            const btn = document.getElementById('parseBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 解析中...';

            const storeId = parseInt(document.getElementById('inputStoreSelect').value);
            const storeName = masterStores.find(s => s.id === storeId).store;

            const prompt = `
以下のテキストは整体院の実績レポートです。
このテキストから「${storeName}店」に関連する月次データを抽出し、JSON形式で出力してください。

テキスト:
"""
${text}
"""

抽出対象 (すべて数値型、見つからない場合はnull):
- year: 年 (例: 2025)
- month: 月 (例: 12)
- adSpend: 広告費
- newClients: 新規数
- joins: 入会数/成約数
- topPv: TOPページPV
- couponPv: クーポンPV

※JSONのみ出力。
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                let resultText = data.candidates[0].content.parts[0].text;
                // Clean up markdown
                resultText = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                // Fallback Regex for JSON extraction if model adds chatter
                const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) resultText = jsonMatch[0];

                const parsed = JSON.parse(resultText);

                // Fix values
                const currentY = new Date().getFullYear();
                const pYear = parseInt(parsed.year) || currentY;
                const pMonth = parseInt(parsed.month) || (new Date().getMonth() + 1);

                const key = getKey(storeId, pYear, pMonth, currentInputMedia);
                if (!monthlyData[key]) monthlyData[key] = {};
                
                // Merge Data (Overwrite if found in report)
                let updateCount = 0;
                if(parsed.adSpend !== null && parsed.adSpend !== undefined) { monthlyData[key].adSpend = parseInt(parsed.adSpend); updateCount++; }
                if(parsed.newClients !== null && parsed.newClients !== undefined) { monthlyData[key].newClients = parseInt(parsed.newClients); updateCount++; }
                if(parsed.joins !== null && parsed.joins !== undefined) { monthlyData[key].joins = parseInt(parsed.joins); updateCount++; }
                if(parsed.topPv !== null && parsed.topPv !== undefined) { monthlyData[key].topPv = parseInt(parsed.topPv); updateCount++; }
                if(parsed.couponPv !== null && parsed.couponPv !== undefined) { monthlyData[key].couponPv = parseInt(parsed.couponPv); updateCount++; }

                localStorage.setItem("naoru_monthly_data", JSON.stringify(monthlyData));
                
                // Refresh View
                renderInputTable();
                
                if (updateCount > 0) {
                    alert(`解析成功！\n${pYear}年${pMonth}月のデータ(${updateCount}項目)を自動入力しました。\n内容を確認して「保存」ボタンを押してください。`);
                } else {
                    alert("解析しましたが、有効な数値が見つかりませんでした。");
                }

            } catch (e) {
                console.error(e);
                alert("解析に失敗しました。AIがデータを読み取れませんでした。\nテキストの形式を確認してください。");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-microchip"></i> 解析して入力表に反映';
            }
        }

        // --- Competitor Update (AI Real-time Search Logic) ---
        async function updateCompetitorInfo() {
            const apiKey = checkApiKey();
            if (!apiKey) { toggleModal('apiKeyModal'); return; }

            const store = activeStoreData.find(d => d.id === currentStoreId);
            const btn = document.getElementById('compUpdateBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AI調査中...';

            const prompt = `
あなたは市場調査のプロです。以下の店舗の周辺エリアにある「実在する競合整体院」を調査してください。

対象店舗: NAORU整体 ${store.store} 
エリア: ${store.store}駅 (神奈川県/東京都) 周辺

タスク:
Google MapsやHPBに掲載されているような、実在する競合店を5〜10店舗リストアップしてください。
各店舗について、推定される「初回クーポン価格」と「ウリ（特徴）」を抽出してください。

出力形式: JSON配列のみ (余計な文章は禁止)
[
  {"name": "店名", "price": 2980, "feature": "産後骨盤矯正に特化"},
  {"name": "店名", "price": 3980, "feature": "駅直結・深夜まで営業"}
]
`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ google_search: {} }] 
                    })
                });
                
                const data = await response.json();
                
                // Fallback logic for search tool errors
                 let text = "";
                if (data.error) {
                     const response2 = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data2 = await response2.json();
                    if (data2.error) throw new Error(data2.error.message);
                    text = data2.candidates[0].content.parts[0].text;
                } else {
                    text = data.candidates[0].content.parts[0].text;
                }

                // Robust JSON Extraction
                const jsonMatch = text.match(/\[[\s\S]*\]/);
                if (!jsonMatch) throw new Error("JSON not found in response");
                
                const newCompetitors = JSON.parse(jsonMatch[0]);
                
                // Update
                competitorData[currentStoreId] = newCompetitors;
                localStorage.setItem("naoru_competitor_data", JSON.stringify(competitorData));
                
                // Refresh UI (without recursion)
                refreshActiveData();
                renderStoreDetails(); 
                
                alert(`AI調査完了！\n${newCompetitors.length}件の競合情報を更新しました。`);

            } catch (error) {
                console.error(error);
                alert("競合調査に失敗しました。\nAPIキーが有効か、またはAIが情報を取得できませんでした。");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Other Init & Logic (Dashboard, Charts, Chat) ---
        function initTargetDateSelect() {
            const select = document.getElementById('targetDateSelect');
            if(select.options.length > 0) return;
            [2025, 2026].forEach(year => {
                for (let month = 1; month <= 12; month++) {
                    const opt = document.createElement('option');
                    opt.value = `${year}-${month}`;
                    opt.text = `${year}年${month}月実績`;
                    if (year === currentTargetYear && month === currentTargetMonth) opt.selected = true;
                    select.appendChild(opt);
                }
            });
        }
        function changeTargetDate() {
            const val = document.getElementById('targetDateSelect').value;
            const [y, m] = val.split('-');
            currentTargetYear = parseInt(y);
            currentTargetMonth = parseInt(m);
            switchTab('dashboard');
        }
        function updateDashboardSummaries() {
            const itoStores = activeStoreData.filter(d => d.owner === "伊藤");
            const itoSpend = itoStores.reduce((sum, s) => sum + getMonthlyRecord(s.id, currentTargetYear, currentTargetMonth, 'hpb').adSpend, 0);
            const itoNew = itoStores.reduce((sum, s) => sum + s.newClients, 0);
            const itoJoins = itoStores.reduce((sum, s) => sum + getMonthlyRecord(s.id, currentTargetYear, currentTargetMonth, 'hpb').joins, 0);
            document.getElementById('itoCpaDisplay').innerText = "¥" + (itoNew > 0 ? Math.round(itoSpend/itoNew).toLocaleString() : 0);
            document.getElementById('itoRateDisplay').innerText = (itoNew > 0 ? Math.round((itoJoins/itoNew)*100) : 0) + "%";

            const fukuStores = activeStoreData.filter(d => d.owner === "福本");
            const fukuSpend = fukuStores.reduce((sum, s) => sum + getMonthlyRecord(s.id, currentTargetYear, currentTargetMonth, 'hpb').adSpend, 0);
            const fukuNew = fukuStores.reduce((sum, s) => sum + s.newClients, 0);
            const fukuJoins = fukuStores.reduce((sum, s) => sum + getMonthlyRecord(s.id, currentTargetYear, currentTargetMonth, 'hpb').joins, 0);
            document.getElementById('fukuCpaDisplay').innerText = "¥" + (fukuNew > 0 ? Math.round(fukuSpend/fukuNew).toLocaleString() : 0);
            document.getElementById('fukuRateDisplay').innerText = (fukuNew > 0 ? Math.round((fukuJoins/fukuNew)*100) : 0) + "%";
        }

        // Deep Dive Logic (Fixed Recursion)
        let currentStoreId = 0;
        let aiMode = 'analyze';
        let chatHistory = [];

        function setAiMode(mode) {
            aiMode = mode;
            const btnAnalyze = document.getElementById('mode-analyze');
            const btnCopy = document.getElementById('mode-copywrite');
            const auditBtnText = document.getElementById('auditBtnText');
            const placeholder = document.getElementById('chatPlaceholderText');
            if (mode === 'analyze') {
                btnAnalyze.classList.add('active'); btnAnalyze.classList.remove('inactive');
                btnCopy.classList.add('inactive'); btnCopy.classList.remove('active');
                auditBtnText.innerText = "店舗・競合・スタッフ課題を分析する";
                if(placeholder) placeholder.innerHTML = "現状分析モードです。<br>下のボタンを押すと分析を開始します。";
            } else {
                btnCopy.classList.add('active'); btnCopy.classList.remove('inactive');
                btnAnalyze.classList.add('inactive'); btnAnalyze.classList.remove('active');
                auditBtnText.innerText = "HPB掲載用 原稿を生成する";
                if(placeholder) placeholder.innerHTML = "原稿作成モードです。<br>下のボタンを押すと3パターン提案します。";
            }
        }

        function initDeepDive() {
            const select = document.getElementById('deepDiveSelect');
            select.innerHTML = '';
            activeStoreData.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.text = `${d.store} (${d.owner}) - CPA¥${d.cpa.toLocaleString()}`;
                select.appendChild(opt);
            });
            
            currentStoreId = parseInt(select.value);
            renderStoreDetails();
            resetChatUI();
        }

        function renderStoreDetails() {
            // Renders ONLY the left panel details. No chat reset here.
            const store = activeStoreData.find(d => d.id === currentStoreId);
            
            document.getElementById('detailName').innerText = store.store + "店";
            document.getElementById('detailOwner').innerText = store.owner + "オーナー";
            document.getElementById('detailNew').innerText = store.newClients + "人";
            document.getElementById('detailCPA').innerText = "¥" + store.cpa.toLocaleString();
            document.getElementById('detailLink').href = store.url;
            
            // Priority: Memo > Master
            // store.offerMemo comes from getMonthlyRecord which checks localStorage
            const displayOffer = store.offerMemo > 0 ? store.offerMemo : store.offer;
            document.getElementById('detailOfferPrice').innerText = `初回: ¥${displayOffer.toLocaleString()}`;
            
            // PV (Safe Check)
            const elTopPv = document.getElementById('detailTopPv');
            if(elTopPv) elTopPv.innerText = store.topPv ? store.topPv.toLocaleString() : '-';
            
            const elAreaTop = document.getElementById('detailAreaTopPv');
            if(elAreaTop) elAreaTop.innerText = `(Avg: ${store.areaTopPv ? store.areaTopPv.toLocaleString() : '-'})`;
            
            const elCpnPv = document.getElementById('detailCouponPv');
            if(elCpnPv) elCpnPv.innerText = store.couponPv ? store.couponPv.toLocaleString() : '-';
            
            const elAreaCpn = document.getElementById('detailAreaCouponPv');
            if(elAreaCpn) elAreaCpn.innerText = `(Avg: ${store.areaCouponPv ? store.areaCouponPv.toLocaleString() : '-'})`;

            const border = document.getElementById('detailCardBorder');
            border.className = `bg-white rounded-xl shadow-sm p-6 border-l-4 ${store.owner === '伊藤' ? 'border-brand' : 'border-slate-600'}`;

            const staffContainer = document.getElementById('staffList');
            staffContainer.innerHTML = '';
            store.staff.forEach(s => {
                const rate = s.arrivals > 0 ? Math.round((s.joins / s.arrivals) * 100) : 0;
                let barColor = 'bg-slate-400';
                if (rate >= 50) barColor = 'bg-emerald-500';
                else if (rate >= 30) barColor = 'bg-amber-400';
                else barColor = 'bg-rose-500';
                staffContainer.innerHTML += `<div><div class="flex justify-between items-end mb-1"><span class="text-sm font-bold text-slate-700">${s.name}</span><span class="text-xs text-slate-500">成約${s.joins}/${s.arrivals}名 (<span class="font-bold text-slate-800">${rate}%</span>)</span></div><div class="progress-bar-bg"><div class="progress-bar-fill ${barColor}" style="width: ${rate}%"></div></div></div>`;
            });

            const compContainer = document.getElementById('competitorList');
            compContainer.innerHTML = '';
            if (store.competitors && store.competitors.length > 0) {
                store.competitors.forEach(c => {
                    const isCheaper = c.price < displayOffer;
                    compContainer.innerHTML += `<div class="flex justify-between items-center text-sm p-2 rounded ${isCheaper ? 'bg-rose-50 border border-rose-100' : 'bg-slate-50 border border-slate-100'}"><span class="text-slate-700">${c.name}</span><div class="text-right"><span class="font-bold block">¥${c.price.toLocaleString()}</span><span class="text-[10px] text-slate-500">${c.feature}</span></div></div>`;
                });
            } else {
                compContainer.innerHTML = '<p class="text-xs text-slate-400">競合データがありません。「AI調査開始」ボタンを押してください。</p>';
            }
        }

        function changeStore() {
            // Called by select change
            const select = document.getElementById('deepDiveSelect');
            if (select) currentStoreId = parseInt(select.value);
            
            renderStoreDetails();
            resetChatUI(); // Only reset chat on manual store change
        }

        function resetChatUI() {
            chatHistory = [];
            const container = document.getElementById('chatContainer');
            if(container) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-500 text-sm opacity-60" id="chatPlaceholder"><i class="fa-solid fa-comments text-4xl mb-3"></i><p class="text-center" id="chatPlaceholderText">店舗データをセットしました。<br>上のボタンから分析を開始してください。</p></div>`;
            }
            setAiMode(aiMode); 
        }

        function appendMessage(role, text) {
            const container = document.getElementById('chatContainer');
            const placeholder = document.getElementById('chatPlaceholder');
            if(placeholder) placeholder.remove();
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            div.innerHTML = role === 'ai' ? marked.parse(text) : text.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function triggerAiAction() {
            const apiKey = checkApiKey();
            if (!apiKey) { toggleModal('apiKeyModal'); return; }
            const store = activeStoreData.find(d => d.id === currentStoreId);
            const customKnowledge = document.getElementById('customKnowledge').value;
            const displayOffer = store.offerMemo > 0 ? store.offerMemo : store.offer;

            let staffContext = store.staff.map(s => `- ${s.name}: 入会率${s.arrivals > 0 ? Math.round((s.joins/s.arrivals)*100) : 0}%`).join("\n");
            let compContext = store.competitors.map(c => `- ${c.name}: ¥${c.price} (${c.feature})`).join("\n");

            let systemPrompt = `
あなたはNAORU整体院の戦略パートナー「酒井くん」です。
【分析対象 (${currentTargetYear}年${currentTargetMonth}月実績)】
店舗: ${store.store} (${store.owner}オーナー)
CPA: ¥${store.cpa.toLocaleString()} (目標¥5,000)
入会率: ${store.rate}% (目標50%)
自社初回オファー実績: ¥${displayOffer.toLocaleString()}

【Webアクセス状況】
TOPページPV: ${store.topPv} (エリア平均: ${store.areaTopPv})
クーポンページPV: ${store.couponPv} (エリア平均: ${store.areaCouponPv})

【競合】
${compContext}

【スタッフ】
${staffContext}

【NAORUの強み】
1. 最新AI姿勢検査
2. 世界基準の検査・施術技術
3. 海外展開
4. パーソナル指導

【ユーザーからの追加指示】
${customKnowledge ? customKnowledge : "特になし"}
`;

            let userPrompt = "";
            if (aiMode === 'analyze') {
                userPrompt = `この店舗の現状を分析し、競合に勝つための「オファー戦略」と「スタッフ教育方針」を具体的に提案してください。
PVデータ（エリア平均との乖離や遷移率）も踏まえて、Web上の問題点（写真、キャッチコピー、露出不足など）を鋭く指摘してください。`;
            } else {
                userPrompt = `この店舗のホットペッパービューティー掲載用の原稿を3パターン作成してください。

**重要方針:**
1. **キャッチーで広告的な表現**にしてください。「ただの説明」はNGです。
2. **心理トリガー（限定性、ベネフィット、社会的証明、共感）**を刺激する言葉を選んでください。
3. 文字数制限は**「絶対厳守」**です。1文字でも超えると掲載不可となります。

**作成条件:**
1. 絵文字禁止
2. 文字数カウント: 全角1文字=1、半角1文字=0.5
   - **キャッチコピー: 50文字以内 (40〜50文字狙い)**
   - **ボディコピー: 150文字以内 (140〜150文字狙い)**
   - **クーポンタイトル: 36文字以内 (30〜36文字狙い)**

**出力形式:**
各項目の末尾に必ず **(xx.x文字)** とカウントを記載してください。`;
            }

            appendMessage('user', aiMode === 'analyze' ? "現状分析をお願いします。" : "HPB原稿を作成してください。");
            await callGeminiApi(systemPrompt, userPrompt);
        }

        async function sendUserMessage() {
            const input = document.getElementById('userChatInput');
            const text = input.value.trim();
            if (!text) return;
            const apiKey = checkApiKey();
            if (!apiKey) { toggleModal('apiKeyModal'); return; }
            input.value = '';
            appendMessage('user', text);
            let contextInjection = "";
            if (chatHistory.length === 0) {
                const store = activeStoreData.find(d => d.id === currentStoreId);
                contextInjection = `(対象店舗: ${store.store}店) `;
            }
            await callGeminiApi("", contextInjection + text);
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); }
        }

        async function callGeminiApi(systemContext, userMessage) {
            const apiKey = localStorage.getItem("naoru_gemini_api_key");
            const container = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = "loadingBubble";
            loadingDiv.className = "chat-bubble ai";
            loadingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            let contents = [...chatHistory];
            if (systemContext) userMessage = systemContext + "\n\n" + userMessage;
            contents.push({ role: "user", parts: [{ text: userMessage }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: contents })
                });
                const data = await response.json();
                document.getElementById('loadingBubble').remove();
                if (data.error) throw new Error(data.error.message);
                const aiText = data.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                appendMessage('ai', aiText);
            } catch (error) {
                if(document.getElementById('loadingBubble')) document.getElementById('loadingBubble').remove();
                appendMessage('system', `エラーが発生しました: ${error.message}`);
            }
        }

        // --- Charts ---
        let cpaChart, rateChart;
        function initComparisonCharts() {
            const cpaData = [...activeStoreData].sort((a, b) => a.cpa - b.cpa);
            const rateData = [...activeStoreData].sort((a, b) => b.rate - a.rate);
            const ownerColors = { "伊藤": "#e57172", "福本": "#475569" };

            if(cpaChart) cpaChart.destroy();
            cpaChart = new Chart(document.getElementById('cpaChart'), {
                type: 'bar',
                data: { labels: cpaData.map(d => d.store), datasets: [{ label: 'CPA (円)', data: cpaData.map(d => d.cpa), backgroundColor: cpaData.map(d => ownerColors[d.owner]), borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
            });

            if(rateChart) rateChart.destroy();
            rateChart = new Chart(document.getElementById('rateChart'), {
                type: 'bar',
                data: { labels: rateData.map(d => d.store), datasets: [{ label: '入会率 (%)', data: rateData.map(d => d.rate), backgroundColor: rateData.map(d => ownerColors[d.owner]), borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100 } } }
            });
        }

        function populateComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            const sortedData = [...activeStoreData].sort((a, b) => a.cpa - b.cpa);
            tbody.innerHTML = '';
            sortedData.forEach((d, index) => {
                const tr = document.createElement('tr');
                const ownerClass = d.owner === "伊藤" ? "text-brand" : "text-slate-600";
                tr.innerHTML = `<td class="px-4 py-3 border-b text-center">#${index + 1}</td><td class="px-4 py-3 border-b font-bold">${d.store}</td><td class="px-4 py-3 border-b ${ownerClass}">${d.owner}</td><td class="px-4 py-3 border-b text-right">¥${d.cpa.toLocaleString()}</td><td class="px-4 py-3 border-b text-right">${d.rate}%</td><td class="px-4 py-3 border-b text-center">-</td>`;
                tbody.appendChild(tr);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkApiKey();
            switchTab('dashboard');
        });
    </script>
</body>
</html>
