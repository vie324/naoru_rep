<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAORUæ•´ä½“é™¢ æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆ v7.0 | HPBåŸç¨¿ä½œæˆæ©Ÿèƒ½æ­è¼‰</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Brand Color Definition */
        :root {
            --brand-color: #e57172;
            --brand-light: #fce7e7;
            --brand-dark: #c04d4e;
        }

        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #334155; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(229, 113, 114, 0.15); }
        
        /* Utility Classes for Brand Color */
        .text-brand { color: var(--brand-color); }
        .bg-brand { background-color: var(--brand-color); }
        .bg-brand-light { background-color: var(--brand-light); }
        .border-brand { border-color: var(--brand-color); }
        .hover-text-brand:hover { color: var(--brand-color); }
        .hover-bg-brand:hover { background-color: var(--brand-color); }
        .ring-brand:focus { --tw-ring-color: var(--brand-color); }

        /* Loading Animation */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--brand-color);
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
            margin-right: 4px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); opacity: 0.5; }
            50% { transform: translateY(-5px); opacity: 1; }
        }

        /* Tab Styles */
        .tab-btn.active {
            border-bottom: 3px solid var(--brand-color);
            color: var(--brand-color);
            font-weight: 700;
        }
        .tab-btn {
            border-bottom: 3px solid transparent;
            color: #64748b;
        }

        /* Progress Bar */
        .progress-bar-bg {
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
        
        /* Modal */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }

        /* AI Mode Toggle */
        .ai-mode-btn {
            @apply px-3 py-1.5 text-xs font-bold rounded-full transition-colors border border-slate-600;
        }
        .ai-mode-btn.active {
            @apply bg-brand border-brand text-white;
        }
        .ai-mode-btn.inactive {
            @apply bg-transparent text-slate-400 hover:text-white hover:border-slate-400;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- Brand Icon -->
                <div class="bg-brand text-white p-2 rounded-lg shadow-sm">
                    <i class="fa-solid fa-chart-simple"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">NAORUæ•´ä½“ æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆ <span class="text-brand text-sm ml-2">v7.0</span></h1>
                    <p class="text-xs text-slate-500">2025å¹´12æœˆå®Ÿç¸¾ | HPBåŸç¨¿ä½œæˆæ©Ÿèƒ½æ­è¼‰</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 h-full">
                <!-- Tab Navigation -->
                <div class="hidden md:flex space-x-6 h-full mr-4">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active h-full flex items-center gap-2 px-1 text-sm font-medium transition-colors">
                        <i class="fa-solid fa-table-columns"></i> çµŒå–¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </button>
                    <button onclick="switchTab('deepdive')" id="tab-deepdive" class="tab-btn h-full flex items-center gap-2 px-1 text-sm font-medium transition-colors">
                        <i class="fa-solid fa-store"></i> å…¨åº—èˆ—ãƒ»ç«¶åˆåˆ†æ
                    </button>
                </div>

                <!-- API Key Setting Button -->
                <button onclick="toggleModal('apiKeyModal')" class="text-slate-500 hover:text-brand transition-colors" title="APIã‚­ãƒ¼è¨­å®š">
                    <i class="fa-solid fa-gear text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- API Key Alert (Hidden if key exists) -->
        <div id="apiKeyAlert" class="hidden bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r shadow-sm flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa-solid fa-triangle-exclamation text-amber-500 mr-3 text-xl"></i>
                <div>
                    <p class="font-bold text-amber-800 text-sm">AIæ©Ÿèƒ½ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“</p>
                    <p class="text-xs text-amber-700">ã€ŒAIé…’äº•ãã‚“ã€ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å³ä¸Šã®è¨­å®š(âš™ï¸)ã‹ã‚‰Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>
            <button onclick="toggleModal('apiKeyModal')" class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-2 rounded hover:bg-amber-200">
                è¨­å®šã™ã‚‹
            </button>
        </div>

        <!-- ========================================== -->
        <!-- TAB 1: DASHBOARD                           -->
        <!-- ========================================== -->
        <div id="view-dashboard" class="space-y-8">
            
            <!-- Summary Cards -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Ito Summary -->
                <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-brand relative overflow-hidden">
                    <div class="absolute right-4 top-4 opacity-10 text-6xl text-brand"><i class="fa-solid fa-user-tie"></i></div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">ä¼Šè—¤ã‚ªãƒ¼ãƒŠãƒ¼ <span class="text-sm font-normal text-slate-500">(é–¢å†…ãƒ»æºã®å£ãƒ»ä¸Šå¤§å²¡)</span></h2>
                    <div class="grid grid-cols-2 gap-4 mt-4 relative z-10">
                        <div class="bg-brand-light p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">å¹³å‡CPA (HPB)</p>
                            <p class="text-2xl font-bold text-brand">Â¥4,529</p>
                            <span class="text-xs font-bold text-white bg-emerald-500 px-2 py-0.5 rounded-full">ç›®æ¨™é”æˆ</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">å…¨ä½“å…¥ä¼šç‡</p>
                            <p class="text-2xl font-bold text-slate-700">45.7%</p>
                            <span class="text-xs font-bold text-white bg-rose-500 px-2 py-0.5 rounded-full">æœªé” (ç›®æ¨™50%)</span>
                        </div>
                    </div>
                </div>

                <!-- Fukumoto Summary -->
                <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-slate-600 relative overflow-hidden">
                    <div class="absolute right-4 top-4 opacity-10 text-6xl text-slate-600"><i class="fa-solid fa-user-tie"></i></div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">ç¦æœ¬ã‚ªãƒ¼ãƒŠãƒ¼ <span class="text-sm font-normal text-slate-500">(é¶´è¦‹ãƒ»è—¤æ²¢)</span></h2>
                    <div class="grid grid-cols-2 gap-4 mt-4 relative z-10">
                        <div class="bg-slate-100 p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">å¹³å‡CPA (HPB)</p>
                            <p class="text-2xl font-bold text-slate-700">Â¥7,857</p>
                            <span class="text-xs font-bold text-white bg-rose-500 px-2 py-0.5 rounded-full">æœªé”</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">å…¨ä½“å…¥ä¼šç‡</p>
                            <p class="text-2xl font-bold text-slate-700">38.7%</p>
                            <span class="text-xs font-bold text-white bg-rose-500 px-2 py-0.5 rounded-full">æœªé”</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ranking Charts -->
            <section class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-chart-simple text-slate-400 mr-2"></i>å¯¾è±¡5åº—èˆ— ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</h3>
                    </div>
                    <div class="flex gap-4 text-xs font-bold mt-2 md:mt-0">
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-brand"></span> ä¼Šè—¤ã‚ªãƒ¼ãƒŠãƒ¼</div>
                        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-slate-600"></span> ç¦æœ¬ã‚ªãƒ¼ãƒŠãƒ¼</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- CPA Ranking -->
                    <div>
                        <h4 class="text-sm font-bold text-slate-600 mb-2 text-center">CPA (ç²å¾—å˜ä¾¡) <span class="text-xs font-normal text-slate-400">ä½ã„ã»ã©å„ªç§€</span></h4>
                        <div class="chart-container">
                            <canvas id="cpaChart"></canvas>
                        </div>
                    </div>

                    <!-- Rate Ranking -->
                    <div>
                        <h4 class="text-sm font-bold text-slate-600 mb-2 text-center">å…¥ä¼šç‡ (ãƒªãƒ”ãƒ¼ãƒˆç‡) <span class="text-xs font-normal text-slate-400">é«˜ã„ã»ã©å„ªç§€</span></h4>
                        <div class="chart-container">
                            <canvas id="rateChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Comprehensive Table -->
                <div class="mt-8 overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-slate-600 border border-slate-200">
                        <thead class="bg-slate-50 text-slate-700 font-bold">
                            <tr>
                                <th class="px-4 py-3 border-b text-center">ãƒ©ãƒ³ã‚¯</th>
                                <th class="px-4 py-3 border-b">åº—èˆ—å</th>
                                <th class="px-4 py-3 border-b">ã‚ªãƒ¼ãƒŠãƒ¼</th>
                                <th class="px-4 py-3 border-b text-right">CPAå®Ÿç¸¾</th>
                                <th class="px-4 py-3 border-b text-right">å…¥ä¼šç‡</th>
                                <th class="px-4 py-3 border-b text-center">åˆ¤å®š</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="comparisonTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- ========================================== -->
        <!-- TAB 2: DEEP DIVE (With Competitors)        -->
        <!-- ========================================== -->
        <div id="view-deepdive" class="space-y-8 hidden">
            
            <!-- Control Panel -->
            <section class="bg-white rounded-xl shadow-sm p-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="bg-slate-800 text-white p-3 rounded-lg"><i class="fa-solid fa-store"></i></div>
                    <div>
                        <h2 class="text-lg font-bold">å…¨åº—èˆ—ãƒ»ç«¶åˆåˆ†æ</h2>
                        <p class="text-xs text-slate-500">ç«¶åˆæ¯”è¼ƒã¨ã‚¹ã‚¿ãƒƒãƒ•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’çµ±åˆåˆ†æ</p>
                    </div>
                </div>
                <div class="w-full md:w-1/3">
                    <label class="block text-xs font-bold text-slate-500 mb-1">åˆ†æå¯¾è±¡åº—èˆ—ã‚’é¸æŠ</label>
                    <select id="deepDiveSelect" onchange="renderStoreDetails()" class="w-full bg-slate-50 border border-slate-300 text-slate-800 rounded-lg p-2.5 focus:ring-brand focus:border-brand outline-none">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </section>

            <!-- Main Detail Content -->
            <div id="storeDetailContainer" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- Left: Basic Info & Staff Data & Competitors -->
                <div class="lg:col-span-5 space-y-6">
                    
                    <!-- Basic Card -->
                    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-brand" id="detailCardBorder">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold text-slate-800" id="detailName">åº—èˆ—å</h3>
                                <p class="text-sm text-slate-500" id="detailOwner">ã‚ªãƒ¼ãƒŠãƒ¼å</p>
                            </div>
                            <div class="text-right">
                                <a id="detailLink" href="#" target="_blank" class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-slate-200 transition flex items-center gap-1 mb-2">
                                    HPB <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                </a>
                                <p class="text-xs font-bold text-brand" id="detailOfferPrice">åˆå›: Â¥3,500</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="p-3 bg-slate-50 rounded text-center">
                                <p class="text-xs text-slate-500">12æœˆæ–°è¦(HPB)</p>
                                <p class="text-xl font-bold text-slate-800" id="detailNew">-</p>
                            </div>
                            <div class="p-3 bg-slate-50 rounded text-center">
                                <p class="text-xs text-slate-500">CPAå®Ÿç¸¾</p>
                                <p class="text-xl font-bold" id="detailCPA">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Performance -->
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-user-nurse text-brand"></i> ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ æˆç´„ç‡ (12æœˆ)
                        </h4>
                        <div id="staffList" class="space-y-4">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Competitor Intelligence -->
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5"><i class="fa-solid fa-chess text-4xl"></i></div>
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-crosshairs text-slate-500"></i> ã‚¨ãƒªã‚¢ç«¶åˆæ¯”è¼ƒ (åˆå›ã‚ªãƒ•ã‚¡ãƒ¼)
                        </h4>
                        <div id="competitorList" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                        <div class="mt-3 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                            <span class="font-bold text-brand">åˆ†æ:</span> <span id="competitorAnalysisText">...</span>
                        </div>
                    </div>

                </div>

                <!-- Right: AI Sakai-kun Interface -->
                <div class="lg:col-span-7">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl shadow-lg p-6 text-white h-full flex flex-col">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                            <div class="flex items-center gap-3">
                                <!-- Sakai-kun Icon -->
                                <div class="relative flex-shrink-0">
                                    <div class="bg-gradient-to-r from-brand to-rose-400 w-12 h-12 rounded-full flex items-center justify-center text-white border-2 border-white shadow">
                                        <i class="fa-solid fa-user-tie text-2xl"></i>
                                    </div>
                                    <span class="absolute -bottom-1 -right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-slate-800"></span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg">AIé…’äº•ãã‚“ <span class="text-xs font-normal text-slate-300 ml-2">Webæˆ¦ç•¥ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</span></h3>
                                    <p class="text-xs text-slate-400">NAORUã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸææ¡ˆ</p>
                                </div>
                            </div>
                            
                            <!-- Mode Toggle -->
                            <div class="flex bg-slate-700 rounded-full p-1">
                                <button onclick="setAiMode('analyze')" id="mode-analyze" class="ai-mode-btn active">ç¾çŠ¶åˆ†æ</button>
                                <button onclick="setAiMode('copywrite')" id="mode-copywrite" class="ai-mode-btn inactive">HPBåŸç¨¿ä½œæˆ</button>
                            </div>
                        </div>

                        <!-- Output Box -->
                        <div class="flex-grow bg-slate-800/50 rounded-lg border border-slate-700 p-4 mb-4 overflow-y-auto max-h-[600px] text-sm leading-relaxed" id="aiOutputBox">
                            <div class="flex flex-col items-center justify-center h-full text-slate-500 text-sm opacity-60">
                                <i class="fa-solid fa-comments text-4xl mb-3"></i>
                                <p class="text-center" id="aiPlaceholder">å·¦å´ã§åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>ç«¶åˆãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ãŸåˆ†æã‚’é–‹å§‹ã—ã¾ã™ã€‚</p>
                            </div>
                        </div>

                        <button onclick="runStoreAudit()" id="auditBtn" class="w-full bg-brand hover:bg-rose-400 text-white font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-all">
                            <span id="auditBtnText">åº—èˆ—ãƒ»ç«¶åˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•èª²é¡Œã‚’åˆ†æã™ã‚‹</span>
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-slate-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-slate-800">Gemini APIè¨­å®š</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal('apiKeyModal')">
                        <i class="fa-solid fa-xmark text-slate-500 text-xl"></i>
                    </div>
                </div>
                <p class="text-sm text-slate-600 mb-4">AIé…’äº•ãã‚“ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Google Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</p>
                <label class="block text-sm font-bold text-slate-700 mb-2" for="apiKeyInput">API Key</label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:border-brand" id="apiKeyInput" type="password">
                <div class="flex justify-end pt-4 gap-2">
                    <button onclick="toggleModal('apiKeyModal')" class="px-4 py-2 bg-slate-200 text-slate-600 rounded hover:bg-slate-300 transition text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="saveApiKey()" class="px-4 py-2 bg-brand text-white rounded hover:bg-rose-500 transition text-sm font-bold">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-800 text-slate-400 py-6 text-center text-xs mt-12">
        <p>NAORU Seitai Management System | Powered by Gemini API</p>
    </footer>

    <!-- Logic Script -->
    <script>
        // --- 0. API Key Logic ---
        function toggleModal(modalID){
            document.getElementById(modalID).classList.toggle("opacity-0");
            document.getElementById(modalID).classList.toggle("pointer-events-none");
            document.body.classList.toggle("modal-active");
            if (!document.getElementById(modalID).classList.contains("opacity-0")) {
                const key = localStorage.getItem("naoru_gemini_api_key");
                if (key) document.getElementById("apiKeyInput").value = key;
            }
        }
        function saveApiKey() {
            const key = document.getElementById("apiKeyInput").value.trim();
            if (key) {
                localStorage.setItem("naoru_gemini_api_key", key);
                document.getElementById("apiKeyAlert").classList.add("hidden");
                toggleModal('apiKeyModal');
                alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            } else alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        function checkApiKey() {
            const key = localStorage.getItem("naoru_gemini_api_key");
            if (!key) {
                document.getElementById("apiKeyAlert").classList.remove("hidden");
                return false;
            }
            return key;
        }

        // --- 1. Data Definitions (Enriched) ---
        const storeData = [
            { 
                id: 0, owner: "ä¼Šè—¤", store: "é–¢å†…", cpa: 4583, rate: 53.8, newClients: 12, offer: 3500,
                url: "https://beauty.hotpepper.jp/kr/slnH000551741/",
                staff: [ { name: "ç¦æœ¬", arrivals: 3, joins: 2 }, { name: "ç¦å€‰", arrivals: 10, joins: 5 } ],
                competitors: [
                    { name: "ã‚«ãƒ©ãƒ€ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢å†…", price: 3980, feature: "å¤§æ‰‹ãƒ»é§…è¿‘" },
                    { name: "é–¢å†…ã‚«ã‚¤ãƒ­", price: 4500, feature: "è€èˆ—ãƒ»æŠ€è¡“" },
                    { name: "ãƒªãƒ©ã‚¯é–¢å†…", price: 3200, feature: "ãƒªãƒ©ã‚¯ãƒ»å®‰ä¾¡" }
                ]
            },
            { 
                id: 1, owner: "ä¼Šè—¤", store: "æºã®å£", cpa: 2200, rate: 35.0, newClients: 20, offer: 2200,
                url: "https://beauty.hotpepper.jp/kr/slnH000690916/",
                staff: [ { name: "ç±³è°·", arrivals: 4, joins: 3 }, { name: "å¤§é‡", arrivals: 8, joins: 3 }, { name: "æ°¸ç”°", arrivals: 8, joins: 1 } ],
                competitors: [
                    { name: "æºã®å£æ•´ä½“é™¢", price: 2980, feature: "åœ°åŸŸå¯†ç€" },
                    { name: "Re.Ra.Ku æºã®å£", price: 3500, feature: "ãƒªãƒ©ã‚¯ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³" },
                    { name: "æ¿€å®‰ãƒãƒƒã‚µãƒ¼ã‚¸", price: 1980, feature: "60åˆ†2980å††ç³»" }
                ]
            },
            { 
                id: 2, owner: "ä¼Šè—¤", store: "ä¸Šå¤§å²¡", cpa: 27500, rate: 100.0, newClients: 2, offer: 3500,
                url: "https://beauty.hotpepper.jp/kr/slnH000720856/",
                staff: [ { name: "æœ‰è·¯", arrivals: 1, joins: 1 }, { name: "å²¡æœ¬", arrivals: 1, joins: 1 } ],
                competitors: [
                    { name: "ã‚ãŠãã‚‰æ•´éª¨é™¢", price: 2600, feature: "ã‚¨ãƒªã‚¢æœ€å®‰ãƒ»ä¿é™º" },
                    { name: "åŒ  ä¸Šå¤§å²¡", price: 2980, feature: "å€‹å®¤ãƒ»é«˜ç´šæ„Ÿ" },
                    { name: "ã‚«ãƒ©ãƒ€ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼", price: 3300, feature: "èªçŸ¥åº¦No.1" }
                ]
            },
            { 
                id: 3, owner: "ç¦æœ¬", store: "é¶´è¦‹", cpa: 6875, rate: 34.8, newClients: 8, offer: 3300,
                url: "https://beauty.hotpepper.jp/kr/slnH000675689/",
                staff: [ { name: "è²æœ«", arrivals: 12, joins: 5 }, { name: "è°·å£", arrivals: 11, joins: 3 } ],
                competitors: [
                    { name: "é¶´è¦‹ä¸­å¤®æ•´éª¨é™¢", price: 1500, feature: "ä¿é™ºãƒ»æ¿€å®‰" },
                    { name: "ãƒ©ãƒ•ã‚£ãƒ é¶´è¦‹", price: 2200, feature: "ãƒªãƒ©ã‚¯ãƒ»çŸ­æ™‚é–“" },
                    { name: "æ•´ä½“é™¢ æ™´", price: 4980, feature: "é«˜å˜ä¾¡ãƒ»é‡ç—‡" }
                ]
            },
            { 
                id: 4, owner: "ç¦æœ¬", store: "è—¤æ²¢", cpa: 9167, rate: 50.0, newClients: 6, offer: 3300,
                url: "https://beauty.hotpepper.jp/kr/slnH000765038/",
                staff: [ { name: "å®®å·", arrivals: 8, joins: 4 } ],
                competitors: [
                    { name: "è—¤æ²¢æ•´ä½“é™¢", price: 3980, feature: "ãƒœã‚­ãƒœã‚­ã—ãªã„" },
                    { name: "ã‚Šã‚‰ãã‚‹ è—¤æ²¢", price: 2980, feature: "æ·±å¤œå–¶æ¥­" },
                    { name: "æ¹˜å—ã‚«ã‚¤ãƒ­", price: 5500, feature: "è€èˆ—ãƒ»é«˜å˜ä¾¡" }
                ]
            }
        ];

        let currentStoreId = 0;
        let aiMode = 'analyze'; // 'analyze' or 'copywrite'

        // --- 2. UI Logic ---
        function switchTab(tabName) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-deepdive').classList.add('hidden');
            document.getElementById('tab-dashboard').classList.remove('active');
            document.getElementById('tab-deepdive').classList.remove('active');
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function setAiMode(mode) {
            aiMode = mode;
            const btnAnalyze = document.getElementById('mode-analyze');
            const btnCopy = document.getElementById('mode-copywrite');
            const auditBtnText = document.getElementById('auditBtnText');
            
            if (mode === 'analyze') {
                btnAnalyze.classList.add('active'); btnAnalyze.classList.remove('inactive');
                btnCopy.classList.add('inactive'); btnCopy.classList.remove('active');
                auditBtnText.innerText = "åº—èˆ—ãƒ»ç«¶åˆãƒ»ã‚¹ã‚¿ãƒƒãƒ•èª²é¡Œã‚’åˆ†æã™ã‚‹";
            } else {
                btnCopy.classList.add('active'); btnCopy.classList.remove('inactive');
                btnAnalyze.classList.add('inactive'); btnAnalyze.classList.remove('active');
                auditBtnText.innerText = "HPBæ²è¼‰ç”¨ åŸç¨¿ã‚’ç”Ÿæˆã™ã‚‹";
            }
        }

        function initDeepDive() {
            const select = document.getElementById('deepDiveSelect');
            storeData.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.text = `${d.store} (${d.owner}) - CPAÂ¥${d.cpa.toLocaleString()}`;
                select.appendChild(opt);
            });
            renderStoreDetails();
        }

        function renderStoreDetails() {
            const id = parseInt(document.getElementById('deepDiveSelect').value);
            currentStoreId = id;
            const store = storeData.find(d => d.id === id);

            document.getElementById('detailName').innerText = store.store + "åº—";
            document.getElementById('detailOwner').innerText = store.owner + "ã‚ªãƒ¼ãƒŠãƒ¼";
            document.getElementById('detailNew').innerText = store.newClients + "äºº";
            document.getElementById('detailCPA').innerText = "Â¥" + store.cpa.toLocaleString();
            document.getElementById('detailLink').href = store.url;
            document.getElementById('detailOfferPrice').innerText = `åˆå›: Â¥${store.offer.toLocaleString()}`;
            
            const border = document.getElementById('detailCardBorder');
            border.className = `bg-white rounded-xl shadow-sm p-6 border-l-4 ${store.owner === 'ä¼Šè—¤' ? 'border-brand' : 'border-slate-600'}`;

            const staffContainer = document.getElementById('staffList');
            staffContainer.innerHTML = '';
            store.staff.forEach(s => {
                const rate = s.arrivals > 0 ? Math.round((s.joins / s.arrivals) * 100) : 0;
                let barColor = 'bg-slate-400';
                if (rate >= 50) barColor = 'bg-emerald-500';
                else if (rate >= 30) barColor = 'bg-amber-400';
                else barColor = 'bg-rose-500';

                const html = `
                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-sm font-bold text-slate-700">${s.name}</span>
                            <span class="text-xs text-slate-500">æˆç´„${s.joins}/${s.arrivals}å (<span class="font-bold text-slate-800">${rate}%</span>)</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill ${barColor}" style="width: ${rate}%"></div>
                        </div>
                    </div>
                `;
                staffContainer.innerHTML += html;
            });

            const compContainer = document.getElementById('competitorList');
            const analysisText = document.getElementById('competitorAnalysisText');
            compContainer.innerHTML = '';

            let cheaperCompetitors = 0;
            store.competitors.forEach(c => {
                const isCheaper = c.price < store.offer;
                if(isCheaper) cheaperCompetitors++;
                compContainer.innerHTML += `
                    <div class="flex justify-between items-center text-sm p-2 rounded ${isCheaper ? 'bg-rose-50 border border-rose-100' : 'bg-slate-50 border border-slate-100'}">
                        <span class="text-slate-700">${c.name}</span>
                        <div class="text-right">
                            <span class="font-bold block">Â¥${c.price.toLocaleString()}</span>
                            <span class="text-[10px] text-slate-500">${c.feature}</span>
                        </div>
                    </div>
                `;
            });

            if (cheaperCompetitors >= 2) {
                analysisText.innerText = `ç«¶åˆã‚ˆã‚Šä¾¡æ ¼ãŒé«˜ã‚ã§ã™(è² ã‘: ${cheaperCompetitors}åº—èˆ—)ã€‚é«˜å˜ä¾¡ã®ç†ç”±(æŠ€è¡“ãƒ»æ¤œæŸ»)ã®è¨´æ±‚ãŒå¿…è¦ã§ã™ã€‚`;
            } else if (cheaperCompetitors > 0) {
                analysisText.innerText = `ã‚¨ãƒªã‚¢ç›¸å ´ã¨åŒç­‰ã§ã™ã€‚ä¾¡æ ¼ä»¥å¤–ã®å·®åˆ¥åŒ–ãŒé‡è¦ã§ã™ã€‚`;
            } else {
                analysisText.innerText = `ã‚¨ãƒªã‚¢å†…ã§ã¯å®‰ä¾¡ãªéƒ¨é¡ã§ã™ã€‚ä¾¡æ ¼ç«¶äº‰åŠ›ã¯ã‚ã‚Šã¾ã™ã€‚`;
            }

            document.getElementById('aiPlaceholder').innerHTML = `ã€Œ${store.store}åº—ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚<br>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€AIé…’äº•ãã‚“ãŒå›ç­”ã—ã¾ã™ã€‚`;
            document.getElementById('aiOutputBox').innerHTML = document.getElementById('aiOutputBox').querySelector('.flex').outerHTML; // Reset to placeholder
        }

        function populateComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            const sortedData = [...storeData].sort((a, b) => a.cpa - b.cpa);

            sortedData.forEach((d, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                
                let statusBadge = "";
                if (d.cpa <= 5000 && d.rate >= 50) {
                    statusBadge = '<span class="px-2 py-1 rounded bg-emerald-100 text-emerald-700 text-xs font-bold">S (å„ªè‰¯)</span>';
                } else if (d.cpa <= 5000) {
                    statusBadge = '<span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-bold">A (è¦æˆç´„ç‡)</span>';
                } else if (d.rate >= 50) {
                    statusBadge = '<span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">B (è¦CPA)</span>';
                } else {
                    statusBadge = '<span class="px-2 py-1 rounded bg-rose-100 text-rose-700 text-xs font-bold">C (è¦æ”¹å–„)</span>';
                }

                const ownerClass = d.owner === "ä¼Šè—¤" ? "text-brand" : "text-slate-600";

                tr.innerHTML = `
                    <td class="px-4 py-3 border-b text-center font-bold text-slate-500">#${index + 1}</td>
                    <td class="px-4 py-3 border-b font-bold text-slate-800">${d.store}</td>
                    <td class="px-4 py-3 border-b font-medium ${ownerClass}">${d.owner}</td>
                    <td class="px-4 py-3 border-b text-right font-bold">Â¥${d.cpa.toLocaleString()}</td>
                    <td class="px-4 py-3 border-b text-right">${d.rate}%</td>
                    <td class="px-4 py-3 border-b text-center">${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. Gemini AI Logic (Updated) ---
        async function runStoreAudit() {
            const apiKey = checkApiKey();
            if (!apiKey) { toggleModal('apiKeyModal'); return; }

            const store = storeData.find(d => d.id === currentStoreId);
            const btn = document.getElementById('auditBtn');
            const outputBox = document.getElementById('aiOutputBox');

            btn.disabled = true;
            btn.innerHTML = '<span>é…’äº•ãã‚“ãŒæ€è€ƒä¸­...</span><div class="typing-indicator ml-2"><span></span><span></span><span></span></div>';
            
            let prompt = "";
            let staffContext = store.staff.map(s => `- ${s.name}: å…¥ä¼šç‡${s.arrivals > 0 ? Math.round((s.joins/s.arrivals)*100) : 0}%`).join("\n");
            let compContext = store.competitors.map(c => `- ${c.name}: Â¥${c.price} (${c.feature})`).join("\n");

            if (aiMode === 'analyze') {
                // --- Mode: Analysis ---
                prompt = `
ã‚ãªãŸã¯NAORUæ•´ä½“é™¢ã®æˆ¦ç•¥ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€Œé…’äº•ãã‚“ã€ã§ã™ã€‚
ä»¥ä¸‹ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€å…·ä½“çš„ã‹ã¤è¾›å£ãªæ”¹å–„ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

ã€åº—èˆ—æƒ…å ±ã€‘
åº—èˆ—: ${store.store} (${store.owner}ã‚ªãƒ¼ãƒŠãƒ¼)
è‡ªç¤¾åˆå›ã‚ªãƒ•ã‚¡ãƒ¼: Â¥${store.offer}
CPA: Â¥${store.cpa.toLocaleString()} (ç›®æ¨™Â¥5,000)
å…¥ä¼šç‡: ${store.rate}% (ç›®æ¨™50%)

ã€ç«¶åˆç’°å¢ƒã€‘
${compContext}

ã€ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾ã€‘
${staffContext}

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ(Markdown)ã€‘
### ğŸ§ é…’äº•ã®çœ¼ (ç¾çŠ¶åˆ†æ)
(ç«¶åˆã¨ã®ä¾¡æ ¼å·®ã€ã‚¹ã‚¿ãƒƒãƒ•ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‹ã‚‰è¦‹ãŸæ ¹æœ¬åŸå› )

### ğŸ’¡ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³
1. **[ã‚ªãƒ•ã‚¡ãƒ¼æˆ¦ç•¥]**: ç«¶åˆ(${store.competitors[0].name}ç­‰)ã«å¯¾ã—ã€ä¾¡æ ¼ã‚’å¤‰ãˆã‚‹ã¹ãã‹ã€è¦‹ã›æ–¹ã‚’å¤‰ãˆã‚‹ã¹ãã‹ã€‚
2. **[ã‚¹ã‚¿ãƒƒãƒ•æ•™è‚²]**: å…·ä½“çš„ãªã‚¹ã‚¿ãƒƒãƒ•åã‚’æŒ™ã’ãŸå¯¾ç­–ã€‚
3. **[ã‚ªãƒ¼ãƒŠãƒ¼ã¸]**: å®Ÿè¡Œã™ã¹ãã‚¿ã‚¹ã‚¯ã€‚
`;
            } else {
                // --- Mode: HPB Copywriting ---
                prompt = `
ã‚ãªãŸã¯ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼(HPB)é›†å®¢ã®ãƒ—ãƒ­ã€Œé…’äº•ãã‚“ã€ã§ã™ã€‚
NAORUæ•´ä½“ ${store.store}åº—ã®æ²è¼‰ãƒšãƒ¼ã‚¸ç”¨åŸç¨¿ã‚’3æ¡ˆä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€å‰æ: NAORUæ•´ä½“ã®å¼·ã¿ã€‘
1. æœ€æ–°ã®AIã‚’ç”¨ã„ãŸå§¿å‹¢æ¤œæŸ»
2. ä¸–ç•ŒåŸºæº–ã®æ¤œæŸ»ãƒ»æ–½è¡“æŠ€è¡“
3. æµ·å¤–å±•é–‹ã‚‚ã™ã‚‹ä¿¡é ¼æ€§
4. æ ¹æœ¬æ”¹å–„ã®ãŸã‚ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æŒ‡å°

ã€ç«¶åˆç’°å¢ƒã€‘
${compContext}
(â€»ç«¶åˆã¨å·®åˆ¥åŒ–ã§ãã‚‹ã‚ˆã†ãªã€ŒæŠ€è¡“åŠ›ã€ã€ŒAIåˆ†æã€ã‚’å¼·èª¿ã—ã¦ãã ã•ã„)

ã€ä½œæˆè¦ä»¶ï¼ˆå³å®ˆï¼‰ã€‘
1. **çµµæ–‡å­—ã¯ä½¿ç”¨ç¦æ­¢**
2. ä»¥ä¸‹ã®æ–‡å­—æ•°åˆ¶é™ã‚®ãƒªã‚®ãƒªã‚’æ”»ã‚ã¦ãã ã•ã„ï¼ˆç›®æŒ‡ã›åˆ¶é™ã‚¸ãƒ£ã‚¹ãƒˆï¼‰
   - å…¨è§’1æ–‡å­—ã€åŠè§’0.5æ–‡å­—æ›ç®—
   - å°‘ãªã„ã¨æã§ã™ã€‚æ ã‚’ä½¿ã„åˆ‡ã£ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›é …ç›®ã€‘
ä»¥ä¸‹ã®3ç‚¹ã‚»ãƒƒãƒˆã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

**ãƒ‘ã‚¿ãƒ¼ãƒ³A (æŠ€è¡“ãƒ»ä¿¡é ¼é‡è¦–)**
1. **ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼** (50æ–‡å­—ã¡ã‚‡ã†ã©)
2. **ãƒœãƒ‡ã‚£ã‚³ãƒ”ãƒ¼** (50æ–‡å­—ã¡ã‚‡ã†ã©)
3. **ã‚¯ãƒ¼ãƒãƒ³ã‚¿ã‚¤ãƒˆãƒ«** (36æ–‡å­—ã¡ã‚‡ã†ã©)

**ãƒ‘ã‚¿ãƒ¼ãƒ³B (AIãƒ»æ¤œæŸ»é‡è¦–)**
... (åŒæ§˜)

**ãƒ‘ã‚¿ãƒ¼ãƒ³C (æ‚©ã¿è§£æ±ºãƒ»å…±æ„Ÿ)**
... (åŒæ§˜)

â€»å„é …ç›®ã®æœ«å°¾ã«(ç´„xxæ–‡å­—)ã¨æ–‡å­—æ•°ã‚’è¨˜è¼‰ã—ã¦ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const aiText = data.candidates[0].content.parts[0].text;
                outputBox.innerHTML = `<div class="prose prose-invert prose-sm max-w-none leading-relaxed">${marked.parse(aiText)}</div>`;
            } catch (error) {
                console.error(error);
                outputBox.innerHTML = `<p class="text-rose-400 text-center mt-10">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br><span class="text-xs">${error.message}</span></p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = document.getElementById('auditBtnText').innerText + ' <i class="fa-solid fa-paper-plane"></i>';
            }
        }

        // --- 4. Charts Logic ---
        function initComparisonCharts() {
            const cpaData = [...storeData].sort((a, b) => a.cpa - b.cpa);
            const rateData = [...storeData].sort((a, b) => b.rate - a.rate);
            const ownerColors = { "ä¼Šè—¤": "#e57172", "ç¦æœ¬": "#475569" };

            new Chart(document.getElementById('cpaChart'), {
                type: 'bar',
                data: { labels: cpaData.map(d => d.store), datasets: [{ label: 'CPA (å††)', data: cpaData.map(d => d.cpa), backgroundColor: cpaData.map(d => ownerColors[d.owner]), borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, annotation: { annotations: { line1: { type: 'line', xMin: 5000, xMax: 5000, borderColor: '#e57172', borderWidth: 2, borderDash: [5, 5], label: { content: 'ç›®æ¨™ Â¥5,000', enabled: true, position: 'end', color: '#e57172' } } } } }, scales: { x: { beginAtZero: true } } }
            });

            new Chart(document.getElementById('rateChart'), {
                type: 'bar',
                data: { labels: rateData.map(d => d.store), datasets: [{ label: 'å…¥ä¼šç‡ (%)', data: rateData.map(d => d.rate), backgroundColor: rateData.map(d => ownerColors[d.owner]), borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, annotation: { annotations: { line1: { type: 'line', xMin: 50, xMax: 50, borderColor: '#10b981', borderWidth: 2, borderDash: [5, 5], label: { content: 'ç›®æ¨™ 50%', enabled: true, position: 'end', color: '#10b981' } } } } }, scales: { x: { beginAtZero: true, max: 100 } } }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkApiKey();
            initComparisonCharts();
            populateComparisonTable();
            initDeepDive();
        });
    </script>
</body>
</html>
